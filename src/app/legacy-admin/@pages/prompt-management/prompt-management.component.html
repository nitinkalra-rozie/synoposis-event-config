<app-top-bar />
<div class="main-content">
  <div class="content-container">
    <!-- Side Panel -->

    <mat-tab-group class="tab-group" [(selectedIndex)]="selectedTabIndex">
      <!-- TAB 1: View and Edit Prompts -->
      <mat-tab label="View and edit prompts">
        <div class="tab-content">
          <h2>Choose prompt configuration</h2>

          <!-- Session Type & Report Type dropdowns -->
          <div class="row">
            <mat-form-field appearance="fill">
              <mat-label>Session Type</mat-label>
              <mat-select
                [(ngModel)]="selectedSession"
                (ngModelChange)="selectedReportType.set('')">
                @for (s of sessionTypes(); track s) {
                  <mat-option [value]="s.sessionType">{{
                    formatDisplayName(s.sessionType)
                  }}</mat-option>
                }
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="fill">
              <mat-label>Report Type</mat-label>
              <mat-select
                [(value)]="selectedReportType"
                (selectionChange)="fetchVersions()">
                @for (r of availableReportTypes(); track r) {
                  <mat-option [value]="r">
                    {{ formatDisplayName(r) }}</mat-option
                  >
                }
              </mat-select>
            </mat-form-field>
          </div>

          <!-- Versions Table -->
          @if (versions().length > 0) {
            <div>
              <p>Found {{ versions().length }} version(s)</p>
              <table
                mat-table
                class="mat-elevation-z1"
                [dataSource]="versions()">
                <ng-container matColumnDef="version">
                  <th *matHeaderCellDef mat-header-cell>Version</th>
                  <td *matCellDef="let row" mat-cell>{{ row.version }}</td>
                </ng-container>
                <ng-container matColumnDef="promptTitle">
                  <th *matHeaderCellDef mat-header-cell>Prompt Title</th>
                  <td *matCellDef="let row" mat-cell>{{ row.promptTitle }}</td>
                </ng-container>
                <ng-container matColumnDef="promptDescription">
                  <th *matHeaderCellDef mat-header-cell>Prompt Description</th>
                  <td *matCellDef="let row" mat-cell>
                    {{ row.promptDescription }}
                  </td>
                </ng-container>
                <tr *matHeaderRowDef="displayedColumns" mat-header-row></tr>
                <tr
                  *matRowDef="let row; columns: displayedColumns"
                  mat-row
                  [class.selected]="row.version === selectedVersion"
                  (click)="onSelectVersion(row)"></tr>
              </table>
              <!-- Visualize Button -->
              <button
                mat-raised-button
                (click)="goToVisualizeTab()"
                color="primary">
                Visualize
              </button>
            </div>
          } @else {
            <p>No versions found for this prompt.</p>
          }
        </div>
      </mat-tab>

      <!-- TAB 2: Visualize prompt -->
      <mat-tab label="Visualize prompt">
        <div class="tab-content">
          @if (selectedVersion) {
            <h2>Selected version: {{ selectedVersion }}</h2>
            @if (promptContent()) {
              <div>
                <p>
                  <strong>Prompt title:</strong>
                  {{ promptContent()?.prompt_title }}
                </p>
                <p>
                  <strong>Prompt description:</strong>
                  {{ promptContent()?.prompt_description }}
                </p>
                <h3>Inputs</h3>
                @for (input of promptContent()?.inputs; track input) {
                  <div>
                    <mat-form-field appearance="fill" style="width: 100%">
                      <mat-label>
                        {{ input.title }}
                        @if (input.required) {
                          <span style="color: red">*</span>
                        }
                      </mat-label>
                      @if ((input.type || 'text') === 'text') {
                        <input
                          matInput
                          [(ngModel)]="userInputs[input.prompt_key]"
                          placeholder="{{ input.help }}" />
                      }
                      @if (input.type === 'number') {
                        <input
                          matInput
                          [(ngModel)]="userInputs[input.prompt_key]"
                          placeholder="{{ input.help }}"
                          type="number" />
                      }
                    </mat-form-field>
                  </div>
                }
                <!-- Visualize the final prompt -->
                <button
                  mat-raised-button
                  (click)="visualizePrompt()"
                  color="primary">
                  Visualize Prompt
                </button>
                @if (finalPrompt) {
                  <div class="final-prompt">
                    <h4>Prompt Preview</h4>
                    <pre>{{ finalPrompt }}</pre>
                  </div>
                }
              </div>
            } @else {
              <p>Loading prompt content...</p>
            }
          } @else {
            <p>
              No version selected. Please go to "View and edit prompts" and
              select a version.
            </p>
          }
        </div>
      </mat-tab>

      <!-- TAB 3: Upload/Refresh prompts -->
      <mat-tab label="Upload/Refresh prompts">
        <div class="tab-content">
          <button
            mat-raised-button
            (click)="uploadOrRefreshPrompts()"
            color="primary">
            Upload/Refresh Prompts
          </button>
        </div>
      </mat-tab>
    </mat-tab-group>
  </div>
  <div></div>
  <app-sidebar-control-panel></app-sidebar-control-panel>
</div>
