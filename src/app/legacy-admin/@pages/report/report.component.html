<app-top-bar></app-top-bar>
<div class="main-content">
  <div class="content-container">
    <!-- Side Panel -->
    <div class="side-panel">
      <mat-card>
        <mat-card-content>
          <!-- Header Section -->
          <div class="toolbar-container">
            <div class="timezone-section">
              <div>
                <span class="timezone-label">Report</span>
              </div>
            </div>

            <div class="action-buttons">
              <button
                class="refresh-button"
                [disabled]="isLoading"
                (click)="refreshEvents()">
                <mat-icon>refresh</mat-icon>
              </button>
            </div>
          </div>

          <!-- Event Dropdown -->
          <div class="event-selector-section">
            <mat-form-field class="full-width" appearance="outline">
              <mat-label>Select Event</mat-label>
              <input
                matInput
                [disabled]="isLoading"
                [matAutocomplete]="eventAuto"
                [(ngModel)]="eventSearchInput"
                (input)="onEventInputChange($event)"
                placeholder="Search or select an event"
                type="text" />
              <mat-autocomplete
                #eventAuto="matAutocomplete"
                [displayWith]="getEventDisplayValue"
                (optionSelected)="onEventSelected($event)">
                @for (event of filteredEvents; track event.EventIdentifier) {
                  <mat-option [value]="event">
                    {{ event.EventIdentifier }} ({{ event.Domain }})
                  </mat-option>
                }
                @if (filteredEvents.length === 0 && eventSearchInput) {
                  <mat-option disabled> No events found </mat-option>
                }
              </mat-autocomplete>
            </mat-form-field>
          </div>

          <!-- Sessions Table -->
          @if (selectedEvent) {
            <div class="sessions-section">
              <div class="sessions-header">
                <h3>Sessions</h3>
                <div class="header-actions">
                  @if (getSelectedFilteredCount() > 0) {
                    <span class="selected-count">
                      {{ getSelectedFilteredCount() }} session(s) selected
                    </span>
                  }
                  <button
                    mat-raised-button
                    class="publish-report-button"
                    [disabled]="
                      getSelectedFilteredCount() === 0 || isLoadingSessions
                    "
                    (click)="publishReport()"
                    color="primary">
                    <mat-icon>publish</mat-icon>
                    Publish Report
                  </button>
                </div>
              </div>

              @if (isLoadingSessions) {
                <div class="loading-container">
                  <mat-progress-bar mode="indeterminate"></mat-progress-bar>
                </div>
              } @else if (sessions.length === 0) {
                <div class="no-sessions-message">
                  <p>No sessions available for this event.</p>
                </div>
              } @else {
                <div>
                  <div class="filter-container">
                    <div class="filter-label">
                      <span>Filter</span>
                    </div>
                    <div class="filter-field">
                      <input
                        id="searchInput"
                        (keyup)="applyFilter($event)"
                        placeholder=" "
                        type="text" />
                      <label for="searchInput">Search Session</label>
                    </div>
                    <div class="filter-select">
                      <mat-form-field
                        class="file-filter-select"
                        appearance="outline">
                        <mat-label>File Filter</mat-label>
                        <mat-select
                          [value]="fileFilterMode"
                          (selectionChange)="
                            onFileFilterModeChange($event.value)
                          ">
                          <mat-option value="all">All</mat-option>
                          <mat-option value="publishPdfOnly"
                            >Publish PDF Only</mat-option
                          >
                          <mat-option value="audioFileOnly"
                            >Audio File Only</mat-option
                          >
                          <mat-option value="both"
                            >Both (Publish PDF & Audio File)</mat-option
                          >
                          <mat-option value="either"
                            >Either (Publish PDF or Audio File)</mat-option
                          >
                          <mat-option value="neither"
                            >Neither (No Publish PDF & No Audio
                            File)</mat-option
                          >
                        </mat-select>
                      </mat-form-field>
                    </div>
                  </div>
                  <table
                    mat-table
                    matSort
                    class="versions-table"
                    [dataSource]="dataSource">
                    <!-- Checkbox Column -->
                    <ng-container matColumnDef="select">
                      <th *matHeaderCellDef mat-header-cell>
                        <mat-checkbox
                          [checked]="isAllSelected()"
                          [indeterminate]="isIndeterminate()"
                          (change)="toggleAllSessions($event.checked)">
                        </mat-checkbox>
                      </th>
                      <td
                        *matCellDef="let row; let i = index"
                        mat-cell
                        [class.selected]="selectedRowIndex === i"
                        (click)="highlightRow(row, i)">
                        <mat-checkbox
                          [checked]="isSessionSelected(row.SessionId)"
                          (change)="
                            onSessionToggle(row.SessionId, $event.checked)
                          "
                          (click)="$event.stopPropagation()">
                        </mat-checkbox>
                      </td>
                    </ng-container>

                    <!-- Start Date Column -->
                    <ng-container matColumnDef="startDate">
                      <th *matHeaderCellDef mat-header-cell mat-sort-header>
                        Start Date
                      </th>
                      <td
                        *matCellDef="let row; let i = index"
                        mat-cell
                        [class.selected]="selectedRowIndex === i"
                        (click)="highlightRow(row, i)"
                        style="min-width: 110px">
                        {{ row.StartsAt | date: 'yyyy-MM-dd' }}
                      </td>
                    </ng-container>

                    <!-- Start Time Column -->
                    <ng-container matColumnDef="startTime">
                      <th *matHeaderCellDef mat-header-cell mat-sort-header>
                        Start Time
                      </th>
                      <td
                        *matCellDef="let row; let i = index"
                        mat-cell
                        matTooltipPosition="above"
                        [class.selected]="selectedRowIndex === i"
                        (click)="highlightRow(row, i)">
                        {{ row.StartsAt | date: 'HH:mm' }}
                      </td>
                    </ng-container>

                    <!-- End Time Column -->
                    <ng-container matColumnDef="endTime">
                      <th *matHeaderCellDef mat-header-cell mat-sort-header>
                        End Time
                      </th>
                      <td
                        *matCellDef="let row; let i = index"
                        mat-cell
                        matTooltipPosition="above"
                        [class.selected]="selectedRowIndex === i"
                        (click)="highlightRow(row, i)">
                        {{ row.EndsAt | date: 'HH:mm' }}
                      </td>
                    </ng-container>

                    <!-- Session Title Column -->
                    <ng-container matColumnDef="title">
                      <th *matHeaderCellDef mat-header-cell mat-sort-header>
                        Session Title
                      </th>
                      <td
                        *matCellDef="let row; let i = index"
                        mat-cell
                        [class.selected]="selectedRowIndex === i"
                        (click)="highlightRow(row, i)">
                        {{ row.SessionTitle }}
                      </td>
                    </ng-container>

                    <!-- Session ID Column -->
                    <ng-container matColumnDef="sessionid">
                      <th *matHeaderCellDef mat-header-cell mat-sort-header>
                        Session ID
                      </th>
                      <td
                        *matCellDef="let row; let i = index"
                        mat-cell
                        [class.selected]="selectedRowIndex === i"
                        (click)="highlightRow(row, i)">
                        {{ row.SessionId }}
                      </td>
                    </ng-container>

                    <!-- Status Column -->
                    <ng-container matColumnDef="status">
                      <th *matHeaderCellDef mat-header-cell mat-sort-header>
                        Status
                      </th>
                      <td
                        *matCellDef="let row; let i = index"
                        mat-cell
                        [class.selected]="selectedRowIndex === i"
                        (click)="highlightRow(row, i)">
                        <div
                          style="
                            display: flex;
                            align-items: center;
                            text-align: center;
                          ">
                          @if (row.Status === EventStatus.NotStarted) {
                            <span
                              class="session-status-badge"
                              [ngClass]="getStatusClass(row.Status)">
                              Not Started
                            </span>
                          } @else if (row.Status === EventStatus.InProgress) {
                            <span
                              class="session-status-badge"
                              [ngClass]="getStatusClass(row.Status)"
                              style="background-color: rgb(0, 161, 94)">
                              Live
                            </span>
                          } @else if (row.Status === 'NOT_AVAILABLE') {
                            <span
                              class="session-status-badge"
                              [ngClass]="getStatusClass(row.Status)">
                              Hidden
                            </span>
                          } @else if (
                            row.Status === EventStatus.UnderReview &&
                            !row.Editor
                          ) {
                            <span
                              class="session-status-badge"
                              [ngClass]="getStatusClass(row.Status)">
                              To Review
                            </span>
                          } @else if (
                            row.Status === EventStatus.UnderReview && row.Editor
                          ) {
                            <span
                              class="session-status-badge"
                              [ngClass]="getStatusClass(row.Status)"
                              style="background-color: rgb(156 106 255)">
                              In Review
                            </span>
                          } @else if (
                            row.Status === EventStatus.ReviewComplete
                          ) {
                            <span
                              class="session-status-badge"
                              [ngClass]="getStatusClass(row.Status)"
                              style="background-color: rgb(0, 161, 94)">
                              Completed
                            </span>
                          } @else if (
                            row.Status === EventStatus.ProcessingInsights
                          ) {
                            <span
                              class="session-status-badge"
                              [ngClass]="getStatusClass(row.Status)">
                              Processing Insights
                            </span>
                          }
                        </div>
                      </td>
                    </ng-container>

                    <!-- Track Column -->
                    <ng-container matColumnDef="track">
                      <th *matHeaderCellDef mat-header-cell mat-sort-header>
                        Track
                      </th>
                      <td
                        *matCellDef="let row; let i = index"
                        mat-cell
                        [class.selected]="selectedRowIndex === i"
                        (click)="highlightRow(row, i)">
                        {{ row.Track }}
                      </td>
                    </ng-container>

                    <!-- Type Column -->
                    <ng-container matColumnDef="Type">
                      <th *matHeaderCellDef mat-header-cell mat-sort-header>
                        Type
                      </th>
                      <td
                        *matCellDef="let row; let i = index"
                        mat-cell
                        [class.selected]="selectedRowIndex === i"
                        (click)="highlightRow(row, i)">
                        {{ row.Type }}
                      </td>
                    </ng-container>

                    <!-- PDF Path V1 Column -->
                    <ng-container matColumnDef="pdfPathV1">
                      <th *matHeaderCellDef mat-header-cell mat-sort-header>
                        PDF V1
                      </th>
                      <td
                        *matCellDef="let row; let i = index"
                        mat-cell
                        [class.selected]="selectedRowIndex === i"
                        (click)="highlightRow(row, i)">
                        @if (row.pdfPathV1 && row.pdfVersion) {
                          <button
                            mat-icon-button
                            matTooltip="Open PDF V1"
                            (click)="viewPdfV1(row); $event.stopPropagation()">
                            <mat-icon>picture_as_pdf</mat-icon>
                          </button>
                        } @else {
                          <span style="color: #999">N/A</span>
                        }
                      </td>
                    </ng-container>

                    <!-- PDF Path V2 Column -->
                    <ng-container matColumnDef="pdfPathV2">
                      <th *matHeaderCellDef mat-header-cell mat-sort-header>
                        PDF V2
                      </th>
                      <td
                        *matCellDef="let row; let i = index"
                        mat-cell
                        [class.selected]="selectedRowIndex === i"
                        (click)="highlightRow(row, i)">
                        @if (row.pdfPathV2 && row.pdfVersion) {
                          <button
                            mat-icon-button
                            matTooltip="Open PDF V2"
                            (click)="viewPdfV2(row); $event.stopPropagation()">
                            <mat-icon>picture_as_pdf</mat-icon>
                          </button>
                        } @else {
                          <span style="color: #999">N/A</span>
                        }
                      </td>
                    </ng-container>

                    <!-- Version Column -->
                    <ng-container matColumnDef="version">
                      <th *matHeaderCellDef mat-header-cell mat-sort-header>
                        Version
                      </th>
                      <td
                        *matCellDef="let row; let i = index"
                        mat-cell
                        [class.selected]="selectedRowIndex === i"
                        (click)="highlightRow(row, i)">
                        {{ row.pdfVersion || 'N/A' }}
                      </td>
                    </ng-container>

                    <!-- Publish PDF Column -->
                    <ng-container matColumnDef="publishPdf">
                      <th *matHeaderCellDef mat-header-cell mat-sort-header>
                        Publish PDF
                      </th>
                      <td
                        *matCellDef="let row; let i = index"
                        mat-cell
                        [class.selected]="selectedRowIndex === i"
                        (click)="highlightRow(row, i)">
                        @if (row.reportUrl) {
                          <button
                            mat-icon-button
                            matTooltip="Open Published PDF"
                            (click)="
                              openPublishPdf(row.reportUrl);
                              $event.stopPropagation()
                            ">
                            <mat-icon>picture_as_pdf</mat-icon>
                          </button>
                        } @else {
                          <span style="color: #999">N/A</span>
                        }
                      </td>
                    </ng-container>

                    <!-- Audio File Column -->
                    <ng-container matColumnDef="audioFile">
                      <th *matHeaderCellDef mat-header-cell mat-sort-header>
                        Audio File
                      </th>
                      <td
                        *matCellDef="let row; let i = index"
                        mat-cell
                        [class.selected]="selectedRowIndex === i"
                        (click)="highlightRow(row, i)">
                        @if (row.audioSegmentUrl) {
                          <button
                            mat-icon-button
                            matTooltip="Play Audio File"
                            (click)="
                              openAudioPlayer(row.audioSegmentUrl);
                              $event.stopPropagation()
                            ">
                            <mat-icon>audiotrack</mat-icon>
                          </button>
                        } @else {
                          <span style="color: #999">N/A</span>
                        }
                      </td>
                    </ng-container>

                    <!-- Table Header and Row Declarations -->
                    <tr *matHeaderRowDef="displayedColumns" mat-header-row></tr>
                    <tr
                      *matRowDef="let row; columns: displayedColumns"
                      mat-row
                      [class.selected]="selectedRowIndex === row"></tr>
                  </table>
                  <mat-paginator
                    [length]="totalRecords"
                    [pageSize]="pageSize"
                    [pageSizeOptions]="[5, 10, 20, 50, 100, 200]"
                    showFirstLastButtons></mat-paginator>
                </div>
              }
            </div>
          } @else {
            <div class="no-event-selected">
              <p>Please select an event to view sessions.</p>
            </div>
          }

          @if (isLoading) {
            <div class="loading-container">
              <mat-progress-bar mode="indeterminate"></mat-progress-bar>
            </div>
          }
        </mat-card-content>
      </mat-card>
    </div>
  </div>
</div>
