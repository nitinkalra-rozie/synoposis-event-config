<app-top-bar></app-top-bar>
<div class="main-content">
  <div class="content-container">
    <!-- Side Panel -->
    <div class="side-panel">
      <mat-card>
        <mat-card-content>
          <!-- Header Section -->
          <div class="toolbar-container">
            <div class="timezone-section">
              <div>
                <span class="timezone-label">Report</span>
              </div>
            </div>

            <div class="action-buttons">
              <button
                class="refresh-button"
                [disabled]="isLoading"
                (click)="refreshEvents()">
                <mat-icon>refresh</mat-icon>
              </button>
            </div>
          </div>

          <!-- Event Dropdown -->
          <div class="event-selector-section">
            <mat-form-field class="full-width" appearance="outline">
              <mat-label>Select Event</mat-label>
              <input
                matInput
                [disabled]="isLoading"
                [matAutocomplete]="eventAuto"
                [(ngModel)]="eventSearchInput"
                (input)="onEventInputChange($event)"
                placeholder="Search or select an event"
                type="text" />
              <mat-autocomplete
                #eventAuto="matAutocomplete"
                [displayWith]="getEventDisplayValue"
                (optionSelected)="onEventSelected($event)">
                @for (event of filteredEvents; track event.EventIdentifier) {
                  <mat-option [value]="event">
                    {{ event.EventIdentifier }} ({{ event.Domain }})
                  </mat-option>
                }
                @if (filteredEvents.length === 0 && eventSearchInput) {
                  <mat-option disabled> No events found </mat-option>
                }
              </mat-autocomplete>
            </mat-form-field>
          </div>

          <!-- Sessions Table with Tabs -->
          @if (selectedEvent) {
            <div class="sessions-section">
              <div class="sessions-header">
                <h3>Sessions</h3>
              </div>

              <mat-tab-group (selectedTabChange)="onMainTabChange($event)">
                <!-- Session Debrief Tab -->
                <mat-tab label="Session Debrief">
                  <div class="tab-content">
                    @if (isLoadingSessions) {
                      <div class="loading-container">
                        <mat-progress-bar
                          mode="indeterminate"></mat-progress-bar>
                      </div>
                    } @else if (sessions.length === 0) {
                      <div class="no-sessions-message">
                        <p>No sessions available for this event.</p>
                      </div>
                    } @else {
                      <app-session-debrief
                        [dataSource]="dataSource"
                        [displayedColumns]="displayedColumns"
                        [fileFilterMode]="fileFilterMode"
                        [fromIndex]="fromIndex"
                        [isLoadingSessions]="isLoadingSessions"
                        [pageSize]="pageSize"
                        [pdfFilterMode]="pdfFilterMode"
                        [selectedEventDay]="selectedEventDay"
                        [selectedSessions]="selectedSessions"
                        [toIndex]="toIndex"
                        [totalRecords]="totalRecords"
                        [uniqueDays]="uniqueDays"
                        (editContent)="editContent($event)"
                        (eventDayFilterChange)="onEventDayFilterChange($event)"
                        (fileFilterModeChange)="onFileFilterModeChange($event)"
                        (filterChange)="applyFilter($event)"
                        (generatePdf)="generatePDF()"
                        (highlightRow)="highlightRow($event.row, $event.index)"
                        (openAudioPlayer)="openAudioPlayer($event)"
                        (openPublishPdf)="openPublishPdf($event)"
                        (pdfFilterModeChange)="onPdfFilterModeChange($event)"
                        (publishReport)="publishReport()"
                        (rangeInputChange)="
                          onRangeInputChange($event.field, $event.event)
                        "
                        (selectRange)="selectRange()"
                        (sessionToggle)="
                          onSessionToggle($event.sessionId, $event.checked)
                        "
                        (toggleAll)="toggleAllSessions($event)"
                        (viewPdfV1)="viewPdfV1($event)"
                        (viewPdfV2)="viewPdfV2($event)">
                      </app-session-debrief>
                    }
                  </div>
                </mat-tab>

                <!-- Other Debrief Tab -->
                <mat-tab label="Other Debrief">
                  <div class="tab-content">
                    @if (isLoadingSessions) {
                      <div class="loading-container">
                        <mat-progress-bar
                          mode="indeterminate"></mat-progress-bar>
                      </div>
                    } @else if (sessions.length === 0) {
                      <div class="no-sessions-message">
                        <p>No sessions available for this event.</p>
                      </div>
                    } @else {
                      <mat-tab-group
                        (selectedTabChange)="onOtherBriefTabChange($event)">
                        <!-- Daily Debrief Sub-tab -->
                        <mat-tab label="Daily Debrief">
                          <div class="nested-tab-content">
                            <app-daily-debrief
                              [dataSource]="dailyDebriefDataSource"
                              [displayedColumns]="displayedColumnsDailyDebrief"
                              [pageSize]="pageSize"
                              [selectedDailyDebriefs]="selectedDailyDebriefs"
                              [selectedEvent]="selectedEvent"
                              [selectedEventDay]="selectedEventDay"
                              [uniqueDays]="uniqueDays"
                              (dailyDebriefToggle)="
                                onDailyDebriefToggle(
                                  $event.eventDay,
                                  $event.checked
                                )
                              "
                              (editContent)="editContentForDailyDebrief($event)"
                              (eventDayFilterChange)="
                                onDailyDebriefEventDayFilterChange($event)
                              "
                              (generateDailyDebrief)="
                                openGenerateDailyDebriefDialog()
                              "
                              (highlightRow)="
                                highlightRow($event.row, $event.index)
                              "
                              (openPublishPdf)="openPublishPdf($event)"
                              (publishReport)="publishDailyDebrief()"
                              (toggleAll)="toggleAllDailyDebriefs($event)"
                              (viewPdfV2)="viewPdfV2ForDailyDebrief($event)">
                            </app-daily-debrief>
                          </div>
                        </mat-tab>
                        <!-- Track Debrief Sub-tab -->
                        <mat-tab label="Track Debrief">
                          <div class="nested-tab-content">
                            <app-track-debrief
                              [dataSource]="trackDebriefDataSource"
                              [displayedColumns]="displayedColumnsTrackDebrief"
                              [fromTrackIndex]="fromTrackIndex"
                              [pageSize]="pageSize"
                              [selectedEvent]="selectedEvent"
                              [selectedTrackDebriefs]="selectedTrackDebriefs"
                              [toTrackIndex]="toTrackIndex"
                              [trackDebriefPdfFilterMode]="
                                trackDebriefPdfFilterMode
                              "
                              [trackDebriefPublishFilterMode]="
                                trackDebriefPublishFilterMode
                              "
                              [trackSearchFilter]="trackSearchFilter"
                              [uniqueTracks]="uniqueTracks"
                              (editContent)="editContentForTrackDebrief($event)"
                              (generateTrackDebrief)="
                                openGenerateTrackDebriefDialog()
                              "
                              (highlightRow)="
                                highlightRow($event.row, $event.index)
                              "
                              (openPublishPdf)="openPublishPdf($event)"
                              (pdfFilterModeChange)="
                                onTrackDebriefPdfFilterModeChange($event)
                              "
                              (publishFilterModeChange)="
                                onTrackDebriefPublishFilterModeChange($event)
                              "
                              (publishReport)="publishTrackDebrief()"
                              (rangeInputChange)="
                                onTrackDebriefRangeInputChange(
                                  $event.field,
                                  $event.event
                                )
                              "
                              (searchFilterChange)="
                                applyTrackDebriefSearchFilter($event)
                              "
                              (selectRange)="selectTrackDebriefRange()"
                              (toggleAll)="toggleAllTrackDebriefs($event)"
                              (trackDebriefToggle)="
                                onTrackDebriefToggle(
                                  $event.track,
                                  $event.checked
                                )
                              "
                              (viewPdfV2)="viewPdfV2ForTrackDebrief($event)">
                            </app-track-debrief>
                          </div>
                        </mat-tab>
                        <!-- Executive Summary Sub-tab -->
                        <mat-tab label="Executive Summary">
                          <div class="nested-tab-content">
                            <app-executive-summary
                              [dataSource]="executiveSummaryDataSource"
                              [displayedColumns]="
                                displayedColumnsExecutiveSummary
                              "
                              [pageSize]="pageSize"
                              [selectedEvent]="selectedEvent"
                              [selectedExecutiveSummaries]="
                                selectedExecutiveSummaries
                              "
                              [uniqueDays]="uniqueDays"
                              (editContent)="
                                editContentForExecutiveSummary($event)
                              "
                              (executiveSummaryToggle)="
                                onExecutiveSummaryToggle(
                                  $event.executiveSummaryId,
                                  $event.checked
                                )
                              "
                              (generateExecutiveSummary)="
                                openGenerateExecutiveSummaryDialog()
                              "
                              (highlightRow)="
                                highlightRow($event.row, $event.index)
                              "
                              (openPublishPdf)="openPublishPdf($event)"
                              (publishReport)="publishExecutiveSummary()"
                              (toggleAll)="toggleAllExecutiveSummaries($event)"
                              (uploadManualPublishReport)="
                                onUploadManualPublishReport($event)
                              "
                              (viewPdfV2)="
                                viewPdfV2ForExecutiveSummary($event)
                              ">
                            </app-executive-summary>
                          </div>
                        </mat-tab>
                      </mat-tab-group>
                    }
                  </div>
                </mat-tab>
              </mat-tab-group>
            </div>
          } @else {
            <div class="no-event-selected">
              <p>Please select an event to view sessions.</p>
            </div>
          }

          @if (isLoading) {
            <div class="loading-container">
              <mat-progress-bar mode="indeterminate"></mat-progress-bar>
            </div>
          }
        </mat-card-content>
      </mat-card>
    </div>
  </div>
</div>
